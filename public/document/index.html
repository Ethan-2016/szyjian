<!doctype html>
<html lang="zh">

<head>
    <meta charset="utf-8" />
    <link rel="icon" href="./favicon.ico" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
    <meta name="theme-color" content="#000000" />
    <meta name="description" content="EMR Editor" />
    <link rel="apple-touch-icon" href="./logo192.png" />
    <link type="text/json" rel="manifest" href="./manifest.json" />
    <title>表单编辑器</title>
    <!-- <link href="./static/css/emr.css" rel="stylesheet"> -->
    <link type="text/css" href="css/emr.chunk.css" rel="stylesheet">

    <script type="text/javascript" src="./js/socket.io.min.js"></script>
    <script type="text/javascript" src="./js/commonJS.js"></script>
    <script type="text/javascript" src="./js/libs/vue.js"></script>
    <script type="text/javascript" src="./js/libs/element-ui/lib/index.js"></script>
    <script type="text/javascript" src="./js/libs/axios.min.js"></script>
    <script type="text/javascript" src="./js/libs/moment-with-locales.min.js"></script>

    <link type="text/css" rel="stylesheet" href="./css/theme/index.css">
    <link type="text/css" rel="stylesheet" href="css/common.css">

    <style>
        .vue-box .el-dialog {
            margin-top: 30px !important;
            width: 70%;
        }
    </style>
</head>

<body style="width: 100%;">
    <noscript>You need to enable JavaScript to run this app.</noscript>

    <div id="root"></div>
    <!-- 打印时透明遮罩层 -->
    <div class="mask" id="mask"
        style="display: none; position: fixed; z-index: 1000000000; top: 0; right: 0; bottom: 0; left: 0; background-color: transparent;">
    </div>
    <!-- 引用模板弹窗 -->
    <div class="vue-box">
        <el-dialog title="护理记录" class="spec-record-dialog" :visible.sync="dialogRecordVisible"
            :close-on-click-modal="false">
            <div class="record-content">
                <!-- <p>护理记录</p> -->
                <el-input type="textarea" v-model="specRecord" :autosize="{ minRows: 4, maxRows: 6}"></el-input>
            </div>
            <div class="tbox" style="margin-top: 15px;">
                <el-tabs v-model="recordActiveName" type="card" @tab-click="handleReordClick" size="small">
                    <el-tab-pane label="病情模板" name="first">
                        <div class="search-box" style="padding-top: 0; padding-left: 0;">
                            <div class="search-cell">
                                <el-input v-model="templateName" placeholder="模板名称" size="small"></el-input>
                            </div>
                            <el-button type="primary" size="small" @click="getTemplateList">查询</el-button>
                        </div>
                        <el-table border :data="templateTableData" @row-click="handleSelectRow" style="width: 100%;"
                            height="200" size="small" :header-cell-style="{background:'#eef1f6'}">
                            <el-table-column prop="name" label="名称" width="180"></el-table-column>
                            <el-table-column prop="value.content" label="内容" align="left"></el-table-column>
                        </el-table>
                    </el-tab-pane>
                    <el-tab-pane label="医嘱" name="second">
                        <el-date-picker v-model="adviceDate" type="date" placeholder="选择日期时间" size="small"
                            @change="adviceDateChange" style="margin-bottom: 15px;">
                        </el-date-picker>

                        <el-table v-loading="adviceLoading" border size="small" highlight-current-row
                            ref="multipleTable" :data="adviceTableData"
                            :header-cell-style="{background:'#eef1f6',color:'#606266',padding: '5px 0'}"
                            :header-row-style="{height: '20px'}" :row-style="{height:'20px'}" @select="tableSelect"
                            @select-all="checkboxAll" style="width: 100%" height="200">
                            <el-table-column align="center" type="selection" width="40"></el-table-column>
                            <el-table-column label="组标" prop="leftFlag" width="60"></el-table-column>
                            <el-table-column label="医嘱" prop="adviceItemName" show-overflow-tooltip></el-table-column>
                            <el-table-column label="组标" prop="rightFlag" width="60"></el-table-column>
                            <el-table-column label="类型" prop="timeLimit" width="60">
                                <template slot-scope="scope">
                                    <span>{{scope.row.timeLimit==1?"长期":"短期"}}</span>
                                </template>
                            </el-table-column>
                            <el-table-column label="剂量" prop="dose" width="100"></el-table-column>
                            <el-table-column label="单位" prop="unit" width="60"></el-table-column>
                            <el-table-column label="给药途径" width="180" prop="drugRoute"></el-table-column>
                            <el-table-column label="下达时间" prop="startTime"></el-table-column>
                        </el-table>
                    </el-tab-pane>
                    <!-- 暂时隐藏 -->
                    <!-- <el-tab-pane label="诊断" name="second">
                    <el-table border :data="diagnosisTableData" @row-click="handleSelectRow" style="width: 100%;" height="300"
                        size="small" :header-cell-style="{background:'#eef1f6'}">
                        <el-table-column prop="type" label="类别" width="100"></el-table-column>
                        <el-table-column prop="diagnosisDescription" label="结果" align="left"></el-table-column>
                    </el-table>
                </el-tab-pane>
                <el-tab-pane label="手术" name="third">
                    <el-table border :data="operationTableData" @row-click="handleSelectRow" style="width: 100%;"
                        height="300" size="small" :header-cell-style="{background:'#eef1f6'}">
                        <el-table-column type="index" label="序号" width="50"></el-table-column>
                        <el-table-column prop="startTime" label="开始时间" width="180"></el-table-column>
                        <el-table-column prop="projectName" label="手术名称"></el-table-column>
                    </el-table>
                </el-tab-pane>
                <el-tab-pane label="医嘱" name="fourth">
                    <div class="advice-btn">
                        <el-button type="primary" size="small" @click="selectAdviceContent" :disabled="adviceAble">确定</el-button>
                    </div>
                    <el-tabs v-model="adviceActiveName" type="card" @tab-click="adviceTab">
                        <el-tab-pane label="长期医嘱" name="adviceFirst">
                            <el-table border :data="longAdviceTableData" @selection-change="handleTempAdviceSelect" style="width: 100%;" height="300" size="small" :header-cell-style="{background:'#eef1f6'}">
                                <el-table-column type="selection" label="" width="50"></el-table-column>
                                <el-table-column prop="adviceType" label="类别" width="60"></el-table-column>
                                <el-table-column prop="adviceItemName" label="名称" width="100"></el-table-column>
                                <el-table-column prop="planExecTime" label="计划开始时间"></el-table-column>
                                <el-table-column prop="frequency" label="频率"></el-table-column>
                                <el-table-column prop="minNum" label="一次用量"></el-table-column>
                                <el-table-column prop="dose" label="剂量单位"></el-table-column>
                                <el-table-column prop="wayType" label="用法">
                                    <template slot-scope="scope">
                                        {{scope.row.wayType | filterWayType}}
                                    </template>
                                </el-table-column>
                                <el-table-column prop="realExecTime" label="用药/执行时间"></el-table-column>
                                <el-table-column prop="adviceContent" label="医嘱说明/备注说明"></el-table-column>
                                <el-table-column label="持续天数">
                                    <template slot-scope="scope">
                            
                                    </template>
                                </el-table-column>
                                <el-table-column prop="" label="数量/剂数"></el-table-column>
                                <el-table-column prop="stopTime" label="结束时间"></el-table-column>
                            </el-table>
                        </el-tab-pane>
                        <el-tab-pane label="临时医嘱" name="adviceSecond">
                            <el-table border :data="tempAdviceTableData" @selection-change="handleTempAdviceSelect" style="width: 100%;" height="300" size="small" :header-cell-style="{background:'#eef1f6'}">
                                <el-table-column type="selection" label="" width="50"></el-table-column>
                                <el-table-column prop="adviceType" label="类别" width="60"></el-table-column>
                                <el-table-column prop="adviceItemName" label="名称" width="100"></el-table-column>
                                <el-table-column prop="planExecTime" label="计划开始时间"></el-table-column>
                                <el-table-column prop="frequency" label="频率"></el-table-column>
                                <el-table-column prop="minNum" label="一次用量"></el-table-column>
                                <el-table-column prop="dose" label="剂量单位"></el-table-column>
                                <el-table-column prop="wayType" label="用法">
                                    <template slot-scope="scope">
                                        {{scope.row.wayType | filterWayType}}
                                    </template>
                                </el-table-column>
                                <el-table-column prop="realExecTime" label="用药/执行时间"></el-table-column>
                                <el-table-column prop="adviceContent" label="医嘱说明/备注说明"></el-table-column>
                                <el-table-column label="持续天数">
                                    <template slot-scope="scope">
                                        
                                    </template>
                                </el-table-column>
                                <el-table-column prop="" label="数量/剂数"></el-table-column>
                                <el-table-column prop="stopTime" label="结束时间"></el-table-column>
                            </el-table>
                        </el-tab-pane>
                        <el-tab-pane label="检验" name="adviceThird">
                            <el-table border :data="adviceInspectTableData" @row-click="handleInspectRowClick" style="width: 100%;" height="300"
                                size="small" :header-cell-style="{background:'#eef1f6'}">
                                <el-table-column prop="name" label="名称" width="100"></el-table-column>
                                <el-table-column prop="value.content" label="结果" align="left"></el-table-column>
                            </el-table>
                        </el-tab-pane>
                    </el-tabs>
                </el-tab-pane>
                <el-tab-pane label="检查" name="fifth">
                    <el-table border :data="inspectTableData" @row-click="handleInspectTabRowClick" style="width: 200px;" height="300"
                        size="small" :header-cell-style="{background:'#eef1f6'}">
                        <el-table-column prop="inspectTime" label="时间" width="90"></el-table-column>
                        <el-table-column prop="projectName" label="名称"></el-table-column>
                    </el-table>
                </el-tab-pane> -->
                </el-tabs>
            </div>
            <div slot="footer" class="dialog-footer">
                <el-button type="primary" @click="insertContentToTable" size="small" id="ensure">确 定</el-button>
                <el-button size="small" id="cancelReferDialog">取 消</el-button>
            </div>
        </el-dialog>
    </div>
    <div class="el-dialog__wrapper" id="dialog-del" size="small"
        style="z-index: 2003; background-color: rgba(0,0,0,.3); display: none;">
        <div role="dialog" aria-modal="true" aria-label="删除签名" class="el-dialog"
            style="margin-top: 15vh; width: 400px;">
            <div class="el-dialog__header">
                <span class="el-dialog__title">删除签名</span>
                <button type="button" aria-label="Close" class="el-dialog__headerbtn">
                    <i class="el-dialog__close el-icon el-icon-close" id="del-close"></i>
                </button>
            </div>
            <div class="el-dialog__body">
                <span>是否确定删除签名？</span>
            </div>
            <div class="el-dialog__footer">
                <button type="button" class="el-button el-button--primary el-button--small" id="del-btn">
                    <span>确 定</span>
                </button>
                <button type="button" class="el-button el-button--default el-button--small" id="del-hide">
                    <span>取 消</span>
                </button>
            </div>
        </div>
    </div>
    <!-- 审核者签名弹窗 -->
    <div class="el-dialog__wrapper" id="dialog-wrapper" size="small"
        style="z-index: 2003; background-color: rgba(0,0,0,.3); display: none;">
        <div role="dialog" aria-modal="true" aria-label="审核者签名" class="el-dialog"
            style="margin-top: 15vh; width: 400px;">
            <div class="el-dialog__header">
                <span class="el-dialog__title">签名确认</span>
                <button type="button" aria-label="Close" class="el-dialog__headerbtn">
                    <i class="el-dialog__close el-icon el-icon-close" id="icon-close"></i>
                </button>
            </div>
            <div class="el-dialog__body">
                <form class="el-form" id="dblclick-dialog__body" style="display: none;">
                    <div class="el-form-item el-form-item--feedback is-required">
                        <div class="el-form-item__content">
                            <div class="el-input el-input--small">
                                <input type="text" autocomplete="off" placeholder="请输入审核者账号" class="el-input__inner"
                                    id="username" />
                            </div>
                        </div>
                    </div>
                    <div class="el-form-item el-form-item--feedback is-required">
                        <div class="el-form-item__content">
                            <div class="el-input el-input--small">
                                <input type="password" autocomplete="off" placeholder="密码" class="el-input__inner"
                                    id="password" />
                            </div>
                        </div>
                    </div>
                </form>
                <div id="click-dialog__body" style="display: none;">
                    是否确认签名？
                </div>
            </div>
            <div class="el-dialog__footer" style="border:none;">
                <div class="dialog-footer">
                    <button type="button" class="el-button el-button--primary el-button--small" id="ensure-btn">
                        <span>确 定</span>
                    </button>
                    <button type="button" class="el-button el-button--default el-button--small" id="hide-dialog">
                        <span>取 消</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script type="text/javascript" src="js/axios.js"></script>
    <script type="text/javascript" src="js/form.js"></script>
    <script type="text/javascript" src="js/dynamicform.js"></script>
    <script type="text/javascript" src="js/authorize.js"></script>
    <script type="text/javascript" src="js/templates.js"></script>
    <script type="text/javascript" src="js/advice.js"></script>
    <script type="text/javascript" src="js/hw.js"></script>
    <script type="text/javascript" src="./ueditor/ueditor.config.js"></script>
    <script type="text/javascript" src="./ueditor/ueditor.parse.js"></script>
    <script type="text/javascript" src="./ueditor/ueditor.all.js"></script>
    <script type="text/javascript" src="./ueditor/lang/zh-cn/zh-cn.js"></script>
    <!-- <script type="text/javascript" src="./ueditor/third-party/laydate/laydate.js"></script> -->
    <!-- <script type="text/javascript" src="./ueditor/laydate/laydate.js"></script> -->

    <script>
        // var showBar = getQueryParam('showBar') == 'true' ? true : false;
        var showBar;
        var pattern = getQueryParam('pattern');
        var updateParams = {};
        var patientId = getLocalStorage('patientInfo').patientId || getQueryParam('patientId');
        var patientNo = getLocalStorage('patientInfo').patientNo || getQueryParam('patientNo');
        var appCode = getQueryParam('app_code');
        var formCode = getQueryParam('formCode');
        var isPrint = getQueryParam('print');
        var printType = getQueryParam('printType');

        var projectId = '';
        var hospitalizationId = getLocalStorage('patientInfo') ? getLocalStorage('patientInfo').inpNo : ''; //getLocalStorage('patientInfo') ? getLocalStorage('patientInfo').hospitalizationId : '';
        var inputTime = getQueryParam('inputTime');
        var formDataId = '';
        var addNewFormDataFlag = false; // 是否是新增表单
        var curRowNurseUserid = ''; // 审核者签名时获取到同一行内护士签名的userid
        var checkerSignDom = null; // 签名dom有可能是span/td
        var removeTr = null;
        var curTd = null; // 当前td
        var paper = '';
        var editor = '';
        var tableData = []; // 表格类表单的表格数据
        var $message = window.parent.window.$message || window.top.$message; // 如无法使用$message, 可在main.js中加入：window.$message = Vue.prototype.$message
        // console.log("----------------------", window.parent.$message, window.top)

        //     function checkLeave(){
        // 　　　　event.returnValue="确定离开当前页面吗？";
        // 　　}

        if (pattern === 'readonly') {
            showBar = false;
        } else {
            showBar = true;
        }

        var saveHandler = function (content) {
            console.info(content);
        }

        var readyHandler = function (editor, callback) {
            /**
             * 获取表单数据并渲染
             * nohPatientForm  testTableform
             */
            var formType = 1; // 默认表单类（约定）； 1:表单； 2：表格
            // if (isPrint && formCode.indexOf('t_') < 0) {
            //     document.querySelector('.page-header').style.display = 'flex';
            // }
            if (formCode.indexOf('t_') > -1) {
                formType = 2;
            }
            DynamicForm.getDynamicForm(formCode).then(res => {
                if (res.code === 0) {
                    var htmlstr = res.data.html;
                    updateParams = res.data;

                    if (pattern === 'readonly') {
                        editor.setContent(htmlstr.replace(/\[|\]/g, ''));
                        if (window.parent.getBreadCrumdTitle) { // 调用父iframe的window方法赋值面给包屑title
                            window.parent.getBreadCrumdTitle(res.data.formName);
                        }
                        //不同系统的文书所调表头接口不一样
                        if (appCode === 'aims') {
                            if (window.parent.location.hash.indexOf("/saManagement/saDocIframe") != -1) {
                                projectId = localStorage.getItem("saDocIframeId")
                            } else {
                                projectId = isPrint ? getQueryParam('operId') : getLocalStorage('patientInfo').operId;
                            }
                            console.log('=================================operId is :' + projectId);
                            if (localStorage.getItem("isWhitePaper")) {
                                // setTimeout(()=>{
                                //     InitiFormData({code: 404, msg: "暂无患者信息", data: null}, projectId, formType, appCode, editor);
                                // }, 1000)
                                // let res = {code: 404, msg: "暂无患者信息", data: null}
                                // InitiFormData(res, undefined, formType, appCode, editor);
                                // return;
                                projectId = undefined;
                                // window.UE.getEditor('ueditor').iframe.contentDocument.body.setAttribute("class", "view is-white-paper");
                                let attr = window.UE.getEditor('ueditor').iframe.contentDocument.body.getAttribute("class")
                                window.UE.getEditor('ueditor').iframe.contentDocument.body.setAttribute("class", attr+" is-white-paper");
                            }
                            Form.patientSuspension(projectId).then((res) => {
                                InitiFormData(res, projectId, formType, appCode, editor);
                            })
                        } else if (appCode === 'icis') {
                            projectId = getLocalStorage('activePatientCard').inHosId;
                            console.log('=================================inHostId is :' + projectId);
                            Form.documentPatientInfo(projectId).then((res) => {
                                InitiFormData(res, projectId, formType, appCode, editor);
                            })
                        }
                    } else {
                        editor.setContent(htmlstr);
                    }

                    if (callback) {

                        console.log(callback);
                        callback();
                    }
                    if (isPrint === 'print') {
                        document.getElementById('mask').style.display = 'block';
                        let attr = window.UE.getEditor('ueditor').iframe.contentDocument.body.getAttribute("class")
                        window.UE.getEditor('ueditor').iframe.contentDocument.body.setAttribute("class", attr+" print");
                    }
                }
            })
        }

        function InitiFormData(pres, projectId, formType, appCode, editor) {
            //patientdata={"id":null,"areaId":"4190","deptName":"肿瘤科","bed":"005","hospitalizationId":"0000072840","patientId":"0000875287","patientNo":"4182348","name":"杨世钦","sex":"男","age":"1天9时6分","nursingLevel":3,"conditionLevel":3,"diagnosis":"胃癌","doctorName":"薛琰","nurseName":"谢洁","addDeptTime":"2020-04-02 09:06:59","outHospitalTime":null,"ssnType":"自费","prepayMoney":null,"areaChangeHistory":["肿瘤科"],"bedChangeHistory":["005","002","005"],"allergy":null,"nativePlace":"黑龙江省哈尔滨尚志市","liaisonName":"杨叶妮","liaisonPhone":"13824393893","birthday":"2020-04-01 00:00:00","phone":"18823768575","ethnicGroup":"回族"};
            // console.log('===============================patientdata is :' + JSON.stringify(patientdata));
            if (!localStorage.getItem("isWhitePaper")) {
                var patientdata = pres.data;
                if (patientdata) {
                    renderFormHeadData(patientdata, editor);
                } else {
                    renderFormHeadData({}, editor);
                }
                DynamicForm.getProjectFormData(formCode, projectId, formType, appCode).then(fdres => {
                    var formData = fdres.data;
                    if (fdres.code === 0) {
                        if (formData) {
                            formDataId = formData.id;
                            renderFormData(formData);
                            if (formData.tableData_text) {
                                // renderTableData(editor, JSON.parse(formData.tableData_text));
                                renderTableData(editor, formData.tableData_text);
                                tableData = formData.tableData_text;
                            }
                        } else {
                            renderFormData({});
                            renderTableData(editor, []); // 没有数据时打印需要空白行补充 （在tableSplitByData()）函数内进行操作
                        }

                    }
                }).finally(()=>{
                    setTimeout(()=>{
                        this.aimsClientPrint()
                    }, 1000)
                })
            } else {
                renderFormHeadData({}, editor);
                renderFormData({});
                renderTableData(editor, []); 
                setTimeout(()=>{
                    this.aimsClientPrint()
                })
            }
        }

        // 渲染表单头部病人信息
        function renderFormHeadData(formHeadData, editor) {
            var ueditor = window.UE.getEditor('ueditor');
            var oTable;
            var oDiv = ueditor.document.getElementById('table-wrapper');
            var editorFrame = document.getElementsByTagName('iframe')[0];
            var plugins = editorFrame.contentWindow.document.getElementsByClassName('emr-plugin');
            var fields = document.getElementsByTagName('iframe')[0].contentWindow.document.getElementsByClassName('emr-field-value');

            // window.addPageHeader(editor, origin+'/src/common/images/logo1.png'); // （暂时不使用）
            if (plugins.length > 0) {
                for (var y = 0; y < plugins.length; y++) {
                    var pluginType = plugins[y].getAttribute('emrplugin');
                    if (pluginType === 'input') {
                        var obj = JSON.parse(plugins[y].getAttribute("obj").replace(/\'/g, '"'));
                        if (obj.textType === 'baseInfo' || obj.formHeadData) {
                            var field = plugins[y].getElementsByClassName('emr-field-value')[0];
                            var key = field.getAttribute('name');
                            if (formHeadData[key]) {
                                field.innerText = formHeadData[key];
                            } else {
                                field.innerText = '';
                            }
                        } else if (!!obj.formHeadData && obj.textType == "signature") {
                            let bigImg = document.createElement("img"); //创建一个img元素
                            field.style.height = field.style.lineHeight;
                            bigImg.style.height = field.style.lineHeight; //200个像素 不用加px
                            bigImg.style.width = "auto"; //200个像素 不用加px
                            bigImg.style.maxWidth = field.offsetWidth + "px"; //200个像素 不用加px
                            bigImg.src = formHeadData[key]; //给img元素的src属性赋值
                            field.appendChild(bigImg); //为dom添加子元素img

                        }
                    } else if (pluginType === 'radio') {
                        var obj = JSON.parse(plugins[y].getAttribute("obj").replace(/\'/g, '"'));
                        if (!!obj.formHeadData) {
                            var radios = plugins[y].getElementsByClassName('emr-radio');
                            if (radios.length > 0) {
                                key = radios[0].getAttribute('name');
                                var allRadios = ueditor.document.querySelectorAll('input[name=' + key + '][type=radio]'); // 单选框相同属性可能会被拆在不同的地方（这样会重复循环，没有办法的办法）
                                if (typeof formHeadData[key] != undefined) {
                                    for (var i = 0; i < allRadios.length; i++) {
                                        if (allRadios[i].value == formHeadData[key]) {
                                            allRadios[i].setAttribute('checked', true);
                                        }
                                    }
                                } else {
                                    // console.log(allRadios.length, ' allRadios length');
                                    for (var j = 0; j < allRadios.length; j++) {
                                        allRadios[j].removeAttribute('checked');
                                    }
                                }
                            }
                        }
                    } else if (pluginType === 'checkbox') {
                        var obj = JSON.parse(plugins[y].getAttribute("obj").replace(/\'/g, '"'));
                        if (!!obj.formHeadData) {
                            var checkboxs = plugins[y].getElementsByClassName('emr-checkbox');
                            if (checkboxs.length > 0) {
                                key = checkboxs[0].getAttribute('name');
                                if (formHeadData[key]) { // checkbox的值以数组形式保存提交: '0','1','2'
                                    var checkboxData = formHeadData[key].split(',');
                                    for (var i = 0; i < checkboxs.length; i++) {
                                        checkboxs[i].removeAttribute('checked');
                                        for (var k = 0; k < checkboxData.length; k++) {
                                            if (checkboxs[i].value == checkboxData[k]) {
                                                checkboxs[i].setAttribute('checked', true);
                                            }
                                        }
                                    }
                                } else {
                                    for (var j = 0; j < checkboxs.length; j++) {
                                        checkboxs[j].removeAttribute('checked');
                                        checkboxs[j].checked = '';
                                    }
                                }
                            }
                        }
                    } else if (pluginType === 'textarea') {
                        var obj = JSON.parse(plugins[y].getAttribute("obj").replace(/\'/g, '"'));
                        if (!!obj.formHeadData) {
                            var field = plugins[y].getElementsByClassName('emr-field-value')[0];
                            key = field.getAttribute('name');
                            if (formHeadData[key]) {
                                field.innerHTML = formHeadData[key];
                            } else {
                                field.innerText = '';
                            }
                        }
                    } else if (pluginType === 'select') {
                        var obj = JSON.parse(plugins[y].getAttribute("obj").replace(/\'/g, '"'));
                        if (!!obj.formHeadData) {
                            var field = plugins[y].getElementsByClassName('emr-field-value')[0];
                            key = field.getAttribute('name');
                            field.value = formHeadData[key] || '';
                            field.setAttribute('value', formHeadData[key] || '');
                            field.dataset.option = formHeadData[key] || '';
                            field.dataset.val = formHeadData[key + "Code"] || '';
                        }
                    }
                }
            }
        }

        // 根据返回值渲染表单
        function renderFormData(formData) {
            // console.log(formData, Object.keys(formData).length, '接口返回数据')
            var ueditor = window.UE.getEditor('ueditor');
            var oTable;
            var plugins = ueditor.document.getElementsByClassName('emr-plugin');
            var fields = ueditor.body.getElementsByClassName('emr-field-value');
            var oDiv = ueditor.document.getElementById('table-wrapper');

            if (!oDiv) { // 打印页面没有表格没有被div包含
                oTable = ueditor.body.getElementsByTagName('table')[0];
            } else {
                oTable = oDiv.getElementsByTagName('table')[0];
            }
            if (Object.keys(formData).length > 0) {//根据Signno关键字符确定是签名并追加img显示签名base64
                for (let form in formData) {
                    // if (form.includes('Signno') && formData[form] != 'null' && formData[form]) {
                    //     let name = form.split('Signno')[0];
                    //     let Domvalue = formData[form];
                    //     let fieldDom = ueditor.document.getElementsByName(name)[0]
                    //     fieldDom.setAttribute(name, Domvalue);
                    //     let bigImg = document.createElement("img"); //创建一个img元素
                    //     bigImg.height = "40"; //200个像素 不用加px
                    //     bigImg.width = "80"; //200个像素 不用加px
                    //     bigImg.src = Domvalue; //给img元素的src属性赋值
                    //     setTimeout(() => { fieldDom.appendChild(bigImg); }, 500)//为dom添加子元素img
                    // }
                }
            }
            if (plugins.length > 0 && Object.keys(formData).length > 0) {
                for (var y = 0; y < plugins.length; y++) {
                    var pluginType = plugins[y].getAttribute('emrplugin');
                    var key;

                    switch (pluginType) {
                        case 'input':
                            (function (y) {
                                var field = plugins[y].getElementsByClassName('emr-field-value')[0];
                                var attrObj = JSON.parse(plugins[y].getAttribute('obj').replace(/\'/g, '"'));
                                key = field.getAttribute('name');
                                if (key === 'diagnosis') { // 诊断如果修改了 则取修改后的值(覆盖旧值)
                                    if (formData[key]) {
                                        field.innerText = formData[key];
                                    }
                                } else {
                                    if (attrObj.textType !== 'baseInfo' && !attrObj.formHeadData && attrObj.textType !== "signature") { // 表单病人资料表头字段
                                        if (formData[key]) {
                                            field.innerText = formData[key];
                                        } else {
                                            field.innerText = '';
                                        }
                                    } else if (attrObj.textType == "signature" && !attrObj.formHeadData && formData[key]) {
                                        let bigImg = document.createElement("img"); //创建一个img元素
                                        field.style.height = field.style.lineHeight;
                                        bigImg.style.height = field.style.lineHeight; //200个像素 不用加px
                                        bigImg.style.width = "auto"; //200个像素 不用加px
                                        bigImg.style.maxWidth = field.offsetWidth + "px"; //200个像素 不用加px
                                        bigImg.src = formData[key]; //给img元素的src属性赋值
                                        field.appendChild(bigImg); //为dom添加子元素img
                                    }
                                }

                                if (Object.keys(formData).length < 1 && key === 'nurseSignture') { // 进入表单时自动带出护士签名
                                    plugins[y].getElementsByClassName('emr-field-value')[0].setAttribute('signno', getLocalStorage('loginInfo').username);
                                    plugins[y].getElementsByClassName('emr-field-value')[0].innerText = getLocalStorage('loginInfo').realName;
                                }

                                if (Object.keys(formData).length < 1 && key === 'nurseSignTime') { // 首次默认带出记录时间
                                    plugins[y].getElementsByClassName('emr-field-value')[0].innerText = moment().format('YYYY-MM-DD HH:mm:ss');
                                }

                                if (key === 'nurseSignture' && formData.signUserNo) { // 已提交过
                                    plugins[y].getElementsByClassName('emr-field-value')[0].setAttribute('signno', formData.signUserNo);
                                }
                                if (key === 'checkerSign' && formData.checkerUserNo) {
                                    plugins[y].getElementsByClassName('emr-field-value')[0].setAttribute('signno', formData.checkerUserNo);
                                }

                                if (isPrint && Object.keys(formData).length > 0 && formData[key] && formCode.indexOf('t_') < 0) { // 打印时获取审核者电子签名
                                    var origin = window.location.origin;
                                    var nurseSignture = ueditor.document.getElementById('nurseSignture');
                                    var checkerSign = ueditor.document.getElementById('checkerSign');
                                    var nurseSignElem;
                                    var checkerSignElem;

                                    if (nurseSignture) {
                                        nurseSignElem = nurseSignture.getElementsByClassName('emr-field-value')[0];
                                    }
                                    if (checkerSign) {
                                        checkerSignElem = checkerSign.getElementsByClassName('emr-field-value')[0];
                                    }

                                    if (key === 'nurseSignture') {
                                        var elecNurseSignElem = document.createElement('img');

                                        elecNurseSignElem.style.height = '22px';
                                        elecNurseSignElem.src = origin + '/ims/rbac/user/signature/' + formData.signUserNo;
                                        nurseSignElem.innerHTML = elecNurseSignElem.outerHTML;
                                    } else if (key === 'checkerSign') {
                                        var elecCheckSignElem = document.createElement('img');

                                        elecCheckSignElem.style.height = '22px';
                                        elecCheckSignElem.src = origin + '/ims/rbac/user/signature/' + formData.checkerUserNo;
                                        checkerSignElem.innerHTML = elecCheckSignElem.outerHTML;
                                    }
                                }
                            })(y)
                            break;
                        case 'radio':
                            (function (y) {
                                var obj = JSON.parse(plugins[y].getAttribute("obj").replace(/\'/g, '"'));
                                if (!obj.formHeadData) {
                                    var radios = plugins[y].getElementsByClassName('emr-radio');
                                    if (radios.length > 0) {
                                        key = radios[0].getAttribute('name');

                                        var allRadios = ueditor.document.querySelectorAll('input[name=' + key + '][type=radio]'); // 单选框相同属性可能会被拆在不同的地方（这样会重复循环，没有办法的办法）
                                        // console.log(formData[key], ' formData[key]', key);
                                        // if (formData[key]) {
                                        if (typeof formData[key] != undefined) {
                                            // console.log(allRadios, ' index page allRadios', key);
                                            for (var i = 0; i < allRadios.length; i++) {
                                                if (allRadios[i].value == formData[key]) {
                                                    allRadios[i].setAttribute('checked', true);
                                                }
                                            }
                                        } else {
                                            // console.log(allRadios.length, ' allRadios length');
                                            for (var j = 0; j < allRadios.length; j++) {
                                                allRadios[j].removeAttribute('checked');
                                            }
                                        }
                                    }
                                }
                            })(y)
                            break;
                        case 'checkbox':
                            (function (y) {
                                var obj = JSON.parse(plugins[y].getAttribute("obj").replace(/\'/g, '"'));
                                if (!obj.formHeadData) {
                                    var checkboxs = plugins[y].getElementsByClassName('emr-checkbox');
                                    if (checkboxs.length > 0) {
                                        key = checkboxs[0].getAttribute('name');
                                        if (formData[key]) { // checkbox的值以数组形式保存提交: '0','1','2'
                                            var checkboxData = formData[key].split(',');
                                            for (var i = 0; i < checkboxs.length; i++) {
                                                checkboxs[i].removeAttribute('checked');
                                                for (var k = 0; k < checkboxData.length; k++) {
                                                    if (checkboxs[i].value == checkboxData[k]) {
                                                        checkboxs[i].setAttribute('checked', true);
                                                    }
                                                }
                                            }
                                        } else {
                                            for (var j = 0; j < checkboxs.length; j++) {
                                                checkboxs[j].removeAttribute('checked');
                                                checkboxs[j].checked = '';
                                            }
                                        }
                                    }
                                }
                            })(y)
                            break;
                        case 'textarea':
                            var obj = JSON.parse(plugins[y].getAttribute("obj").replace(/\'/g, '"'));
                            if (!obj.formHeadData) {
                                var field = plugins[y].getElementsByClassName('emr-field-value')[0];
                                key = field.getAttribute('name');

                                if (formData[key]) {
                                    field.innerHTML = formData[key];
                                } else {
                                    field.innerText = '';
                                }
                            }
                            break;
                        case 'tabs': // tab切换
                            var pluginsObj = JSON.parse(plugins[y].getAttribute('obj').replace(/\'/g, '"'));
                            var tabs = plugins[y].getElementsByClassName('emr-tab-li');
                            var tabContentBox = plugins[y].getElementsByClassName('emr-tab-content')[0];
                            var tabContent = tabContentBox.getElementsByClassName('content');
                            var key = pluginsObj.controlId;
                            var att = document.createAttribute("checked");
                            att.value = 'true';

                            if (formData[key]) {
                                var index = Number(formData[key]);
                                // tabs[index].click(function(){
                                //     console.log('tabs click');
                                // }());

                                tabs[index].getElementsByTagName('input')[0].setAttribute('checked', true);
                                // tabs[index].getElementsByTagName('input')[0].setAttributeNode(att);
                                for (var i = 0; i < tabContent.length; i++) {
                                    tabContent[i].style.display = 'none';
                                    if (i === index) {
                                        tabContent[i].style.display = 'block';
                                    }
                                }
                            }
                            break;
                        case 'select':
                            var obj = JSON.parse(plugins[y].getAttribute("obj").replace(/\'/g, '"'));
                            if (!obj.formHeadData) {
                                var field = plugins[y].getElementsByClassName('emr-field-value')[0];
                                key = field.getAttribute('name');
                                field.value = formData[key] || '';
                                field.setAttribute('value', formData[key] || '');
                                field.dataset.option = formData[key] || '';
                                field.dataset.val = formData[key + "Code"] || '';
                            }
                            break;
                        case 'emrbutton':
                            // var signImg = plugins[y].getElementsByTagName('img')[0];
                            // var name = signImg.id;

                            // signImg.src = formData[name] || ''; // base64字符串
                            var obj = JSON.parse(plugins[y].getAttribute("obj").replace(/\'/g, '"'));
                            var key = plugins[y].id
                            plugins[y].dataset.value = formData[key] || plugins[y].dataset.value
                            var tempArr = plugins[y].dataset.value?plugins[y].dataset.value.split(','):[];
                            var btnsNode = plugins[y].getElementsByClassName('btn');
                            for(let j = 0; j < btnsNode.length; j++){
                                if(tempArr.includes(j+'')){
                                    btnsNode[j].style.borderBottom = "1px solid #0e4ddc"
                                }else{
                                    btnsNode[j].style.borderBottom = "none"
                                }
                            }

                            let idStr = plugins[y].id
                            let aboutNode = ueditor.document.getElementsByClassName(`${idStr}`)
                            for(let j = 0; j < aboutNode.length; j++){
                                let index = aboutNode[j].getAttribute('link').split('-')[1]
                                if(tempArr.includes(index)){
                                    aboutNode[j].style.display = "inline-block"
                                }else{
                                    aboutNode[j].style.display = "none"
                                }
                            }
                            break;
                    }
                }
            }
            if (oTable && Object.keys(formData).length > 0) {
                var tableData = formData.tableData;
                var trs = oTable.getElementsByTagName('tr');

                if (tableData) {
                    for (var x = 0; x < trs.length; x++) {
                        var tds = trs[x].getElementsByTagName('td');

                        for (var y = 0; y < tds.length; y++) {
                            var key = tds[y].getAttribute('name');

                            if (tds[y].getAttribute('name') === key) {
                                tds[y].innerText = tableData[key];
                            }
                        }
                    }
                }
            }

            if (isPrint == 'print' && formCode.indexOf('t_') < 0) { // 表单分页
                window.formSplitPage(ueditor, window.paperinfo);
            }
        }


        function aimsClientPrint(){
            if (printType == 'auto' && window.isAimsClient) {
                if (!['mzsfd', 'mzshfsjld', 'ssaqhcb', 'dsahld'].includes(formCode) && !localStorage.getItem("isWhitePaper")) {
                    editor.ref.replaceFields(editor, '/');
                }

                if (updateParams.printOrientation == 0) {
                    if(window.isAimsClient){
                        document.body.style.width = "1455px"
                        document.body.style.height = "820px"
                        document.getElementById("edui9_iframeholder").style.height = "944px"
                    }
                }
                var socket = io(window.aimsSocketHost)
                setTimeout(function () {
                        let res = socket.emit("print-ready",{id: getQueryParam('id')});
                }, 1000)
            }
        }

        function renderTableData(editor, formTableData) { // 渲染表格数据
            // var oTable = editor.body.getElementsByTagName('table')[0];
            var oTable, oTbody;
            var oDiv = editor.document.getElementById('table-wrapper');
            // var oTable = oDiv.getElementsByTagName('table')[0];
            if (!oDiv) { // 打印页面没有表格没有被div包含
                oTable = editor.body.getElementsByTagName('table')[0];
            } else {
                oTable = oDiv.getElementsByTagName('table')[0];
            }
            if (oTable) {
                var trs = oTable.getElementsByTagName('tr');
                oTbody = oTable.getElementsByTagName('tbody')[0];
                if (oTable.id === 'form-table') { // 过滤没有表格数据的表格（如：告知书）           
                    for (var k = 0; k < trs.length; k++) {
                        if (trs[k].id.indexOf('fileds-tr') > -1) {
                            var cloneTr = trs[k].cloneNode(true);
                            var tds = trs[k].getElementsByTagName('td');
                        }
                        if (trs[k].className.indexOf('fileds-tr') < 0) {
                            trs[k].parentNode.removeChild(trs[k]);
                            k--;
                        }
                    }

                    if (formTableData.length > 0) { // 渲染表格数据
                        for (var i = 0; i < formTableData.length; i++) { // 行
                            var newTr = document.createElement('tr');

                            // console.log(formTableData[i].id, 'formTableData[i].id');
                            if (formTableData[i].id && formTableData[i].id !== 'undefined') newTr.setAttribute('dataid', formTableData[i].id);
                            // newTr.setAttribute('dataid', formTableData[i].id != 'undefined' ? formTableData[i].id : ''); // 绑定每条数据id到表格数据tr的属性上，使用时从属性获取
                            for (var j = 0; j < tds.length; j++) { // 列
                                var key = tds[j].innerText;
                                var newTd = document.createElement('td');
                                var align = tds[j].getAttribute('align');
                                var showway = tds[j].getAttribute('showway');
                                var setcontenteditable = tds[j].getAttribute('setcontenteditable');
                                var grade = tds[j].getAttribute('grade');
                                var gradeNum = key.split('_').pop();
                                var selectstr = '';
                                var selectField = key.split('_')[1]; // 下拉或输入下拉字段取第二个作为字段
                                var printSelectStyle = '-webkit-appearance:none;';
                                var printSelectInputStyle = 'width: 100%;'

                                tds[j].setAttribute('name', key);
                                newTd.setAttribute('name', key);
                                newTd.setAttribute('showway', showway);
                                newTd.setAttribute('align', align);
                                newTd.setAttribute('grade', gradeNum);
                                newTd.setAttribute('contenteditable', setcontenteditable);

                                if (key.indexOf('scorelevel') > -1) {
                                    newTd.innerText = formTableData[i].scorelevel || '';
                                    newTd.setAttribute('scorelevelIndex', formTableData[i].scorelevelIndex); // 保存等级方案索引号
                                } else {
                                    if (key.indexOf('select_') > -1) { // 当前列内容为下拉选择
                                        var selected = '';
                                        var options = key.split('_');
                                        options.shift();
                                        options.shift();

                                        selectstr += '<select style="width:100%; height: 100%; text-align:center; border:none; outline:none;' + (isPrint ? printSelectStyle : '') + '">';
                                        selectstr += '<option style="display:none;"></option>';
                                        for (var l = 0; l < options.length; l++) {
                                            if (options[l] == formTableData[i][selectField]) {
                                                selected = 'selected'
                                            }
                                            selectstr += '<option value="' + options[l] + '"' + selected + '>' + options[l] + '</option>';
                                        }
                                        selectstr += '</select>';

                                        newTd.innerHTML = selectstr;
                                    } else if (key.indexOf('selectinput_') > -1) { // 当前列内容为可输入下拉选择
                                        var options = key.split('_');

                                        options.shift();
                                        options.shift();

                                        selectstr += '<div class="table-select-wrapper" style="position:relative; width: 100%; height: 100%;">'
                                        selectstr += '<span style="overflow: hidden;">'
                                        selectstr += '<select style="width:100%; height: 100%; background-color:transparent; font-size: 0; border:none; outline:none;' + (isPrint ? printSelectStyle : '') + '" onchange="var event = window.event; event.stopPropagation(); this.parentNode.nextSibling.value=this.value; window.parent.window.parent.checkChangeState(); this.closest(' + "'tr'" + ').className = ' + "'edittr-bg'" + '; ">'
                                        selectstr += '<option style="display:none;"></option>';
                                        for (var l = 0; l < options.length; l++) {
                                            selectstr += '<option value="' + options[l] + '" style="font-size: 14px;">' + options[l] + '</option>';
                                        }
                                        selectstr += '</select></span><input type="text" value="' + (formTableData[i][selectField] || '') + '" autocomplete="off" style="background-color:transparent; ' + (isPrint ? printSelectInputStyle : 'width:calc(100% - 15px);') + ' position:absolute; left:0px; right: 23px; border:none; top: 0; bottom: 0; outline: none;text-align:center;" /></div>'

                                        newTd.innerHTML = selectstr;
                                    } else if (key.indexOf('nurse_sign') > -1 && formTableData[i].nurseSignNo) { // 护士签名username
                                        newTd.setAttribute('signno', formTableData[i].nurseSignNo);
                                        newTd.innerText = formTableData[i][key] || '';
                                    } else if (key.indexOf('checker_sign') > -1 && formTableData[i].checkerUserNo) {
                                        newTd.setAttribute('signno', formTableData[i].checkerUserNo);
                                        newTd.innerText = formTableData[i][key] || '';
                                    } else if (key.indexOf('dblclick_sign') > -1) { // 双击签名
                                        var curSignKey = key.split('dblclick_sign_')[1];

                                        if (formTableData[i][curSignKey + '_signno']) {
                                            newTd.innerText = formTableData[i][key] || '';
                                            newTd.setAttribute('signno', formTableData[i][curSignKey + '_signno']); // 双击当前格直接签名（如血糖监测）
                                        }
                                    } else {
                                        newTd.innerText = formTableData[i][key] || '';
                                    }
                                }

                                if (isPrint === 'print') {
                                    var origin = window.location.origin;
                                    if (key.indexOf('nurse_sign') > -1) {
                                        var elecCheckSignElem = document.createElement('img');

                                        elecCheckSignElem.style.height = '20px';
                                        elecCheckSignElem.src = origin + '/ims/rbac/user/signature/' + formTableData[i].nurseSignNo;
                                        newTd.innerHTML = elecCheckSignElem.outerHTML;
                                    } else if (key.indexOf('checker_sign') > -1 && formTableData[i].checkerUserNo) { // signuserno
                                        var elecCheckSignElem = document.createElement('img');
                                        // var origin = window.location.origin;

                                        elecCheckSignElem.style.height = '20px';
                                        elecCheckSignElem.src = origin + '/ims/rbac/user/signature/' + formTableData[i].checkerUserNo;
                                        newTd.innerHTML = elecCheckSignElem.outerHTML;
                                    } else if (key.indexOf('dblclick_sign') > -1) {
                                        var dblclickSignElem = document.createElement('img');
                                        // var origin = window.location.origin;
                                        var curSignKey = key.split('dblclick_sign_')[1] + '_signno'

                                        if (formTableData[i][curSignKey]) {
                                            dblclickSignElem.style.height = '20px';
                                            dblclickSignElem.src = origin + '/ims/rbac/user/signature/' + formTableData[i][curSignKey];
                                            newTd.innerHTML = dblclickSignElem.outerHTML;
                                        }
                                    }
                                }

                                newTr.appendChild(newTd);
                            }
                            oTbody.appendChild(newTr)
                            oTable.appendChild(oTbody);
                        }

                    }

                    window.tableEvents(oTable, 'index window');

                    if (isPrint === 'print') { // 表格类表单打印时调用
                        window.tableSplitByData(editor);
                    }

                    // editor.execCommand('insertrow');
                    // console.log('add rows')
                    // console.log(window.UE.UETable, ' window.UE.UETable')
                    // var UETable = new window.UE.UETable(oTable); 
                    // UETable.update(oTable);
                    // console.log(UETable.indexTable, 'UETable.indexTable');

                    // 动态数据渲染后重新计算ueditor高度(表格数据增加的高度)
                    window.calcUeditorHeight(editor);
                    if (!isPrint) {
                        window.scrollToBottom(editor);
                    }
                }
            }
        }

        function hasTableData() { // 打印没有数据提示方法(暂时不用)
            var tabelDataBool = false;
            var tableObj = {
                data: false, // 返回的数据
                newRow: false // 表格新增的行
            }
            var ueditor = window.UE.getEditor('ueditor');
            var table = ueditor.body.getElementsByTagName('table')[0];
            var trs = table.rows;
            var trsLen = 0;

            for (var i = 0; i < trs.length; i++) {
                if (trs[i].className.indexOf('fileds-tr') < 0) {
                    trsLen += 1;
                }
            }

            if (trsLen > tableData.length) { // 如果除了表头行的length 大于返回的表示有新增未保存的表格行
                tableObj.newRow = true;
            }

            if (tableData.length > 0 && !tableObj.newRow) {
                tableObj.data = true;
            }

            return tableObj;
        }

        function getFormData(message) {
            var editor = window.UE.getEditor('ueditor');
            var formType = 1; // 默认表单类（约定）； 1:表单； 2：表格
            if (formCode.indexOf('t_') > -1) {
                formType = 2;
            }

            DynamicForm.getFormData(formCode, patientNo, formType).then(fdres => {
                var formData = fdres.data;
                console.log(fdres, '============getFormData=====DynamicForm.getFormData====');
                if (fdres.code === 0) {
                    if (formData) {
                        formDataId = formData.id;
                        renderFormData(formData);
                        if (formData.tableData_text) {
                            // renderTableData(editor, JSON.parse(formData.tableData_text));
                            renderTableData(editor, formData.tableData_text);
                            tableData = formData.tableData_text;
                        }
                    } else {
                        renderFormData({});
                        renderTableData(editor, []); // 没有数据时打印需要空白行补充 （在tableSplitByData()）函数内进行操作
                    }
                }
            })
        }

        window.onload = function () {
            let signerNameEvent = ''

            DynamicForm.getDynamicForm(formCode).then(res => {
                var orientation = 'portrait';
                var printOrientation = '';
                if (res.code === 0) {
                    var data = res.data;
                    // res.data.paperOrientation;  0: A4竖向； 1：A4横向； 2：铺满
                    if (data.paperOrientation == 0) { // 默认A4
                        orientation = 'landscape';
                    } else if (data.printOrientation == 1) { // 默认纵向
                        // orientation = 'landscape';
                        orientation = 'portrait';
                    } else if (data.paperOrientation == 2) { // 默认A4
                        var paper = 'webpage';
                    }

                    window.localStorage.setItem('printOrientation', data.printOrientation);

                    if (isPrint === 'print') {
                        if (data.printOrientation == 1) { //   1：纵向
                            printOrientation = 'print-portrait';
                        } else if (data.printOrientation == 0) { // 0：横向
                            printOrientation = 'print-landscape';
                        }

                        // 网页打印自动弹出打印预览
                        console.log('网页打印自动弹出打印预览')
                        console.log(getQueryParam('multp'));
                        if (!window.nativePrinter && !getQueryParam('multp')) {
                            setTimeout(function () {
                                
                                if (printType == 'auto' && window.isAimsClient) {

                                  // var ws = new WebSocket(window.aimsSocketHo
                                    //   if (data.printOrientation == 0) {
                                    //     if(window.isAimsClient){
                                    //       document.body.style.width = "1455px"
                                    //       document.body.style.height = "820px"
                                    //       document.getElementById("edui9_iframeholder").style.height = "944px"
                                    //     }
                                    //   }
                                    //   var socket = io(window.aimsSocketHost)
                                    //   setTimeout(function () {
                                    //         let res = socket.emit("print-ready",{id:getQueryParam('id')});
                                    //   }, 1000)
                                  
                                } else {
                                    // console.log("----------", data.printOrientation, window.document.getElementById('ueditor_0').contentWindow.document.body)
                                    // window.print();
                                    if (!['mzsfd', 'mzshfsjld', 'ssaqhcb', 'dsahld'].includes(formCode) && !localStorage.getItem("isWhitePaper")) {
                                        editor.ref.replaceFields(editor, '/');
                                    }
                                    var cssPagedMedia = (function () {
                                        let documentNode = window.document.getElementById('ueditor_0').contentWindow.document
                                        var style = documentNode.createElement("style");
                                        documentNode.head.appendChild(style);
                                        return function (rule) {
                                            style.innerHTML = rule;
                                        };
                                    })();
                                    cssPagedMedia.size = function (size) {
                                        cssPagedMedia("@page {size: " + size + "} ");
                                    };
                                    if (data.printOrientation == 1) { //   1：纵向
                                        cssPagedMedia.size("portrait");
                                    } else if (data.printOrientation == 0) { // 0：横向
                                        cssPagedMedia.size("landscape");
                                    }
                                    if(window.isAimsClient){
                                    }else{
                                      window.document.getElementById('ueditor_0').contentWindow.print()
                                    }
                                    // 关闭后还原
                                    cssPagedMedia.size("portrait");
                                }

                            }, 2000)
                        }else{
                          setTimeout(function () {
                            if (!['mzsfd', 'mzshfsjld', 'ssaqhcb', 'dsahld'].includes(formCode) && !localStorage.getItem("isWhitePaper")) {
                                      editor.ref.replaceFields(editor, '/');
                                  }
                          }, 2000)
                        }
                    }
                }


                editor = window.EMREditor('root', {
                    paper: paper,
                    orientation: orientation,
                    printOrientation: printOrientation,
                    pattern: pattern,
                    showBar: showBar,
                    onSave: saveHandler,
                    onReady: readyHandler,
                    options: {
                        imageActionName: '/uploadUrl'
                    }
                });
                
                window.paperinfo = {
                    paper: paper,
                    orientation: orientation,
                    printOrientation: printOrientation
                }


                // window.UE.getEditor('ueditor').addListener('contentChange',function(){
                //     //相关操作
                //     console.log('editor change')
                // });
            })

            // let editor = window.EMREditor('root', {paper: paper, orientation: orientation, pattern: pattern, showBar: showBar, onSave: saveHandler, onReady: readyHandler });

            // 初始化汉王手写板
            initHwPlugin();
            // 签名按钮
            window.signEvent = function (signId, signType) {
                console.log('签名按钮事件', window.location.href);
                console.log(signId, '图片id');
                // window.open(window.location.href)
                launchFullscreen(document.documentElement);

                // setTimeout(function(){
                hwSign(signId, signType);
                // }, 300);

                // document.addEventListener("hanvonSigndataEvent",function(evt){
                //     /*
                //     监听hanvonSigndataEvent事件获取签名数据值。
                //     */
                //     var obj = evt.detail;
                //     var signimg = obj.whichsign;//签名按钮ID值
                //     console.log(signimg);
                //     var signdata = obj.signdata;//签名数据
                //     console.log(signdata);
                // });
                return '签名图片路径'; // 返回的会在表单组件内
            }

            window.save = function () { // 保存表单模板字符串
                var htmlstr = editor.getContent();
                var fields = editor.ref.getFields(); // getFields() 为emr控件内的方法
                var fieldsName = [];

                for (var key in fields) {
                    fieldsName.push(key);
                }

                fieldsName.push('checkerUserNo'); // 审核者username
                fieldsName.push('signUserNo'); //  
                updateParams.html = htmlstr;
                updateParams.structuredFields = fieldsName;

                // 修改模版
                DynamicForm.updateDynamicForm(updateParams).then(res => {
                    if (res.code === 0) {
                        // alert('表单模板保存成功');
                        $message({
                            message: '表单模板保存成功',
                            type: 'success'
                        })
                    } else {
                        // console.log(res.msg);
                        $message({
                            message: res.msg,
                            type: 'warning'
                        })
                    }
                })
            };

            // 查询表单数据
            window.getRecordOne = function (recordTime) {
                var params = {
                    "code": formCode,
                    "end": "",
                    "recordTime": recordTime,
                    "patientId": patientId,
                    "patientNo": patientNo,
                    "start": ""
                }
                DynamicForm.getFormDataOne(params).then(res => {
                    if (res.code === 0) {
                        if (res.data) {
                            renderFormData(res.data);
                        } else {
                            renderFormData({});
                        }
                    } else {
                        // console.log(res.msg);
                        $message({
                            message: res.msg,
                            type: 'warning'
                        })
                    }
                })
            }

            // 根据日期范围查询表单（表格）数据
            window.getFormDataDateRange = function (dateRange) {
                var params = {
                    "code": formCode,
                    "end": dateRange[1],
                    // "inputTime": inputTime,
                    "patientId": patientId,
                    "patientNo": patientNo,
                    "start": dateRange[0]
                }
                DynamicForm.getFormDataDateRange(params).then(res => {
                    if (res.code === 0) {
                        if (res.data) {
                            var ueditor = window.UE.getEditor('ueditor');
                            renderFormData(res.data);
                            renderTableData(ueditor, res.data.tableData_text);
                        } else {
                            renderFormData({});
                        }
                    } else {
                        // console.log(res.msg);
                        $message({
                            message: res.msg,
                            type: 'error'
                        })
                    }
                })
            }
            /**
             * 文书保存obj
             */
            window.getObj = function () {
                var obj = editor.ref.getFields();
                var ueditor = window.UE.getEditor('ueditor');
                console.log(ueditor.document, 'ueditor.document')
                for (var key in obj) {
                    if (key.includes('Signno')) {
                        let name = key.split('Signno')[0]
                        obj[key] = ueditor.document.getElementsByName(name)[0].getAttribute(name)
                    }
                }
                if (formCode.indexOf('t_') < 0) { // 表单签名username
                    var nurseSignture = ueditor.document.getElementById('nurseSignture');
                    var checkerSign = ueditor.document.getElementById('checkerSign');
                    var signUserNo;
                    var checkerUserNo;

                    if (nurseSignture) {
                        signUserNo = nurseSignture.getElementsByClassName('emr-field-value')[0].getAttribute('signno');
                    }
                    if (checkerSign) {
                        checkerUserNo = checkerSign.getElementsByClassName('emr-field-value')[0].getAttribute('signno');
                    }
                    // 提交护士签名username
                    obj.signUserNo = signUserNo ? signUserNo : '';
                    // 提交审核者username
                    obj.checkerUserNo = checkerUserNo ? checkerUserNo : '';
                }

                if (formCode.indexOf('t_') > -1 && JSON.parse(obj.tableData_text).length === 0) {
                    Message({
                        message: '请添加数据再保存',
                        type: 'warning'
                    })
                    window.parent.app.saveDisabled = false;
                    return;
                }

                if (!addNewFormDataFlag && formDataId) {
                    obj.id = formDataId;
                }
                obj.patient_id = patientId || '0';
                obj.patient_no = patientNo || '2';
                obj.project_id = projectId;
                obj.app_code = appCode;
                obj.system_type = 'aims';
                obj.form_name = updateParams.formName;
                obj.hospitalization_id = hospitalizationId;
                obj.input_time = moment().format('YYYY-MM-DD HH:mm:ss');
                obj.code = formCode;
                if (!obj.nurseSignTime) { // 签名时间
                    obj.nurseSignTime = moment().format('YYYY-MM-DD HH:mm:ss');
                }
                return obj
            }
            // 首次保存
            window.firstSave = function () {
                setTimeout(() => {
                    localStorage.setItem("wenshuOldData", JSON.stringify(window.getObj()))
                }, 2000);
            }

            window.firstSave()
            /**
             * 检验表单是否修改
             * 对比两个对象的值是否完全相等 返回值 true/false
             */
            window.isObjectValueEqual = function () {
                var obj = window.getObj();
                var wenshuOldData = JSON.parse(localStorage.getItem("wenshuOldData"));
                //取对象a和b的属性名
                var aProps = Object.getOwnPropertyNames(obj);
                var bProps = Object.getOwnPropertyNames(wenshuOldData);
                //合并相同属性名，再判断属性值是否一致
                for (let i = 0; i < aProps.length; i++) {
                    for (let j = 0; j < bProps.length; j++) {
                        if (bProps[j] === aProps[i]) {
                            var propName = aProps[i];
                            if (propName != 'input_time' && propName != 'nurseSignTime') {
                                if (obj[propName] != wenshuOldData[propName]) {
                                    return false;
                                }
                            }
                        }
                    }
                }
                return true;
            }
            /**
             * 保存表单数据
             * message 提交成功提示信息，默认不传
             * tdelete 表格删除行标识
             */
            window.saveData = function (selectD, message, tdelete, isPrint) { // 保存表单值数据
                var obj = editor.ref.getFields();
                var objHead = editor.ref.getHeadsFields();
                var ueditor = window.UE.getEditor('ueditor');
                // console.log(selectD, message, tdelete, 'ueditor.document') //ueditor.document, 
                // for (var key in obj) {
                //     if (key.includes('Signno')) {
                //         let name = key.split('Signno')[0]
                //         obj[key] = ueditor.document.getElementsByName(name)[0].getAttribute('data-src')
                //     }
                // }
                // return;
                // 删除表格行数据筛选（删除改用删除接口）
                // obj.tableData_text为数组字符串
                // 通过表格获取总共有多少条数据（一行格式化后为一条数据）
                // 通过选中的行索引号，用splice()方法删除
                // 索引号减去表头行数则为数据中的索引号
                if (tdelete === 't_delete') {
                    var tableData = JSON.parse(obj.tableData_text);
                    var tableDataLen = tableData.length;
                    var removeIndex = removeTr.rowIndex;
                    // var theadLen = tableDataLen;
                    var tableWrapper = ueditor.document.getElementById('table-wrapper');
                    var table = tableWrapper.querySelector('.form-table');
                    var thead = table.querySelectorAll('.fileds-tr');
                    var dataIndex = removeIndex - thead.length;
                    var delRowData = tableData.splice(dataIndex, 1);
                    obj.tableData_text = JSON.stringify(tableData);
                }

                if (formCode.indexOf('t_') < 0) { // 表单签名username
                    var nurseSignture = ueditor.document.getElementById('nurseSignture');
                    var checkerSign = ueditor.document.getElementById('checkerSign');
                    var signUserNo;
                    var checkerUserNo;

                    if (nurseSignture) {
                        signUserNo = nurseSignture.getElementsByClassName('emr-field-value')[0].getAttribute('signno');
                    }
                    if (checkerSign) {
                        checkerUserNo = checkerSign.getElementsByClassName('emr-field-value')[0].getAttribute('signno');
                    }
                    // 提交护士签名username
                    obj.signUserNo = signUserNo ? signUserNo : '';
                    // 提交审核者username
                    obj.checkerUserNo = checkerUserNo ? checkerUserNo : '';
                }

                if (formCode.indexOf('t_') > -1 && JSON.parse(obj.tableData_text).length === 0) {
                    Message({
                        message: '请添加数据再保存',
                        type: 'warning'
                    })
                    window.parent.app.saveDisabled = false;
                    return;
                }

                if (!addNewFormDataFlag && formDataId) {
                    obj.id = formDataId;
                }
                obj.patient_id = patientId || '0';
                obj.patient_no = patientNo || '2';
                obj.project_id = projectId;
                obj.app_code = appCode;
                obj.system_type = 'aims';
                obj.form_name = updateParams.formName;
                obj.hospitalization_id = hospitalizationId;
                obj.input_time = moment().format('YYYY-MM-DD HH:mm:ss');
                obj.code = formCode;
                if (!obj.nurseSignTime) { // 签名时间
                    obj.nurseSignTime = moment().format('YYYY-MM-DD HH:mm:ss');
                }

                let changeItems = []
                for (let key in objHead) {
                    changeItems.push({
                        "key": key,
                        "value": objHead[key],
                        "extra": objHead[key + "Code"]
                    })
                }
                DynamicForm.savePatientInformation({
                    "operId": isPrint ? getQueryParam('operId') : getLocalStorage('patientInfo').operId,
                    "changeItems": changeItems
                }).then(res => {
                    if (res.code != 200) {
                        if (message) {
                            $message({
                                message: message,
                                type: 'success'
                            })
                        }
                    }
                }).catch(err => {
                    window.parent.app.saveDisabled = false;
                })
                DynamicForm.saveDynamicFormData(obj).then(res => {
                    if (res.code === 0) {
                        if (message) {
                            $message({
                                message: message,
                                type: 'success'
                            })
                        }
                        formDataId = '';
                        window.parent.getFormDataRecordList();
                        clearChangeState(); // 清除修改标识
                        window.parent.app.saveDisabled = false; // 按钮恢复可用
                        if (window.parent.quoteField) {
                            window.parent.quoteField(); // 被关联的表单赋值方法
                        } else {
                            getFormData('成功删除数据');
                        }
                    } else {
                        $message({
                            message: res.msg,
                            type: 'success'
                        });
                        window.parent.app.saveDisabled = false; // 按钮恢复可用
                    }
                }).catch(err => {
                    window.parent.app.saveDisabled = false;
                })
                // 如果点了保存需要更新本地缓存  wenshuOldData
                localStorage.setItem("wenshuOldData", JSON.stringify(window.getObj()))
            }

            // 删除非表格类表单数据
            window.deleteFormData = function () {
                if (!formDataId) {
                    // alert('没有可删除的数据');
                    $message({
                        message: '没有可删除的数据',
                        type: 'warning'
                    })
                    return;
                }
                DynamicForm.deleteDynamicFormData(formCode, formDataId).then(res => {
                    if (res.code === 0) {
                        // alert('删除成功');
                        $message({
                            message: '删除成功',
                            type: 'success'
                        })
                        window.parent.getFormDataRecordList();
                        // location.reload();
                        getFormData();
                    } else {
                        $message({
                            message: '删除失败，请检查重试！',
                            type: 'warning'
                        })
                    }
                })
            }

            window.selectCurTr = function (curTr) { // 获取点击删除的行
                removeTr = curTr;
            };

            // 删除表格不再使用保存表格方法，新添加单独的删除接口
            window.removeTableRows = function () { // 移除表格行
                var dataId;
                if (!removeTr) {
                    $message.warning('请点击时间列选中要删除的数据行');
                    return;
                }
                dataId = removeTr.getAttribute('dataid');

                DynamicForm.deleteDynamicTableData(formCode, patientNo, dataId).then((res) => {
                    if (res.code === 0) {
                        $message({
                            message: '删除成功',
                            type: 'success'
                        })
                        removeTr.parentNode.removeChild(removeTr);
                    } else {
                        $message({
                            message: res.msg,
                            type: 'error'
                        })
                    }
                })
                // removeTr.parentNode.removeChild(removeTr); // 移除行dom
                // saveData('删除成功', 't_delete');
            }

            window.handleAddTableRows = function () {
                var ueditor = window.UE.getEditor('ueditor');
                // var oTable = ueditor.body.getElementsByTagName('table')[0];
                var oDiv = ueditor.document.getElementById('table-wrapper');
                var oTable = oDiv.getElementsByTagName('table')[0];
                addTableRows(oTable, ueditor); // emr组件内的方法
                window.parent.checkChangeState(); // 添加修改标识
                // window.calcUeditorHeight(ueditor);
            }

            window.getFields = function () {
                var obj = editor.ref.getFields(); // 表单字段对象
                return obj;
            }

            window.renderFormData = renderFormData; // 暴露表单赋值函数，便于表单引用时赋值给原表单
            window.setChangeStateFn = checkChangeState; // 挂载在窗口让表单编辑器调用

            // 带出表格行日期和时间事件
            window.formatTableDatetime = function (datetype) {
                return moment().format(datetype);
            }

            // 带出表格行护士签名事件
            window.getNurseName = function () {
                var nurseName = '';

                nurseName = JSON.parse(window.localStorage.getItem('loginInfo'));
                return nurseName;
            }

            let signerNameIntervalId = null;
            // 签名弹窗(从emr内触发，传出当前点击的单元格dom)
            window.getSignerName = function (userid, signDom, eventType) {
                if (eventType == "dblclick") {
                    clearInterval(signerNameIntervalId)
                    curRowNurseUserid = userid;
                    checkerSignDom = signDom;
                    let signature = signDom.getAttribute('name')
                    let imgNode = signDom.getElementsByTagName("img")[0]
                    if (imgNode) {//已签名,弹出删除框
                        document.getElementById('dialog-del').style.display = 'block';
                    } else {//没有签名,弹出签名框
                        signerNameEvent = "dblclick"
                        document.getElementById('dialog-wrapper').style.display = 'block';
                        document.getElementById('dblclick-dialog__body').style.display = 'block';
                    }
                } else {
                    clearInterval(signerNameIntervalId)
                    signerNameIntervalId = setTimeout(() => {
                        curRowNurseUserid = userid;
                        checkerSignDom = signDom;
                        let signature = signDom.getAttribute('name')
                        let imgNode = signDom.getElementsByTagName("img")[0]
                        if (imgNode) {//已签名,弹出删除框
                            document.getElementById('dialog-del').style.display = 'block';
                        } else {//没有签名,弹出签名框
                            signerNameEvent = "click"
                            document.getElementById('dialog-wrapper').style.display = 'block';
                            document.getElementById('click-dialog__body').style.display = 'block';
                        }
                    }, 300)
                }
            }

            document.getElementById('del-btn').onclick = function () {//删除签名确定按钮
                // checkerSignDom.removeAttribute('name');//删除元素保存的值
                // console.log("------------------------", checkerSignDom)
                checkerSignDom.innerHTML = "";//移除图片
                checkerSignDom.setAttribute('data-src', '')
                hideDelDialog();
            }

            document.getElementById('del-hide').onclick = function () {//删除签名关闭按钮
                hideDelDialog();
            }
            document.getElementById('del-close').onclick = function () {//删除签名关闭按钮
                hideDelDialog();
            }

            function hideDelDialog() {//关闭--删除签名弹窗
                document.getElementById('dialog-del').style.display = 'none';
            }
            document.getElementById('ensure-btn').onclick = function () {//签名确定按钮
                if (signerNameEvent == "dblclick") {
                    queryCheckerName();
                } else {
                    let src = JSON.parse(localStorage.getItem("vuex")).app.userInfo.extraProperties.Signature
                    if (src) {
                        let bigImg = document.createElement("img"); //创建一个img元素
                        bigImg.style.width = "100%"; //像素不用加px
                        bigImg.style.maxWidth = "80px"; //像素不用加px
                        bigImg.src = src; //给img元素的src属性赋值
                        // console.log('---------------------------', checkerSignDom)
                        checkerSignDom.appendChild(bigImg); //为dom添加子元素img
                        // let name = checkerSignDom.getAttribute('name');//获取name属性值
                        // console.log("signDomsignDomsignDom", name)
                        // checkerSignDom.setAttribute('name', src);
                        checkerSignDom.setAttribute('data-src', src);
                        hideDialog();
                    } else {
                        $message({
                            message: '获取签名图片失败!',
                            type: 'error'
                        });
                        hideDialog();
                    }
                }
            }

            document.getElementById('hide-dialog').onclick = function () {//签名关闭按钮
                hideDialog();
            }
            document.getElementById('icon-close').onclick = function () {//签名关闭按钮
                hideDialog();
            }

            function hideDialog() {//关闭---签名弹窗
                signerNameEvent = "";
                document.getElementById('dialog-wrapper').style.display = 'none';
                document.getElementById('click-dialog__body').style.display = 'none';
                document.getElementById('dblclick-dialog__body').style.display = 'none';
            }

            // 弹窗输入账号密码签名
            window.queryCheckerName = function () {
                var formData = new FormData();
                var username = document.getElementById('username').value;
                var password = document.getElementById('password').value;

                formData.append("username", username);
                formData.append("password", password);
                let params = {
                    userName: username,
                    password: password
                }
                axios.post('/identity/users/signature/fetch', params).then(res => {//急危重症一体化
                    console.log(res, '签名返回')
                    if (res.data) {
                        let bigImg = document.createElement("img"); //创建一个img元素
                        bigImg.style.width = "100%"; //像素不用加px
                        bigImg.style.maxWidth = "80px"; //像素不用加px
                        bigImg.src = res.data; //给img元素的src属性赋值
                        checkerSignDom.appendChild(bigImg); //为dom添加子元素img
                        // let name = checkerSignDom.getAttribute('name');//获取name属性值
                        // checkerSignDom.setAttribute('name', res.data);
                        checkerSignDom.setAttribute('data-src', res.data);
                        document.getElementById('username').value = '';
                        document.getElementById('password').value = '';
                        // checkChangeState();

                    } else {
                        this.$message({
                            message: '获取签名图片失败!',
                            type: 'error'
                        });
                    }
                    hideDialog();
                }).catch(err => {
                    console.log(err.response)
                })
                return;

                Authorize.login(formData).then(res => { //护理文书---  使用登录接口核对账号密码
                    if (res.code === '200') {

                        axios.get("/ims/authorize/info", {
                            headers: {
                                Authorization: localStorage.getItem('checkerauth')
                            },
                            params: formData
                        }).then(userRes => {
                            if (userRes.data.code === 0) {
                                if (userRes.data.data.id == curRowNurseUserid) {
                                    this.$message({
                                        message: '审核者与创建者不能是同一账号',
                                        type: 'warning'
                                    });
                                    return;
                                }

                                var ueditor = window.UE.getEditor('ueditor');
                                var checkerSignTimeElem = ueditor.document.getElementById('checkerSignTime');

                                if (checkerSignTimeElem) {
                                    checkerSignTimeElem.getElementsByClassName('emr-field-value')[0].innerText = moment().format('YYYY-MM-DD HH:mm:ss');
                                }

                                checkerSignDom.innerText = userRes.data.data.realName; // 赋值到表格审核者单元格内或表单审核签名
                                checkerSignDom.setAttribute('signno', userRes.data.data.username);
                                document.getElementById('username').value = '';
                                document.getElementById('password').value = '';
                                checkChangeState();
                                hideDialog();
                            } else {
                                this.$message({
                                    message: '请检查审核者账号密码',
                                    type: 'error'
                                })
                            }
                        })
                    } else {
                        this.$message({
                            message: '登录者账号或者密码错误, 请检查',
                            type: 'error'
                        });
                    }
                })
                return username ? username : '';
            }

            window.openReferenceDialog = function (td) {
                var oldSpecRecord = vue.specRecord;
                curTd = td;
                vue.dialogRecordVisible = true;
                vue.specRecord = td.innerText;
                // return vue.specRecord;
            }

            var ensure = document.querySelector('#ensure');
            // var cancelBtn = document.querySelector('.el-dialog__headerbtn');
            var cancelBtn = document.querySelector('#cancelReferDialog');

            ensure.onclick = function (e) {
                // document.querySelector('#dialog-wrapper').style.display = 'none'; 
                var tr = curTd.parentNode;
                var className = tr.className;
                vue.dialogRecordVisible = false;
                curTd.innerText = vue.specRecord;
                // if(className.indexOf('selecttr-bg') > -1) {
                //     tr.className ="edittr-bg selecttr-bg";
                // } else {
                tr.className = "edittr-bg";
                // }

                console.log(vue.specRecord);
            }
            cancelBtn.onclick = function (e) {
                closeReferDialog();
            }

            function closeReferDialog() {
                vue.dialogRecordVisible = false;
            }

        }
        // var globalDialogVisible = true;
        var vue = new Vue({ // 这里使用vue实例是为了使用element-ui的组件和样式统一
            el: ".vue-box",
            data: {
                dialogRecordVisible: false,
                specRecord: '',
                recordActiveName: 'first',
                adviceDate: moment().format('YYYY-MM-DD'),
                areaId: '',
                templateName: '',
                templateTableData: [],
                adviceLoading: false,
                adviceTableData: [],
                patientInfo: {}
            },
            mounted() {
                this.patientInfo = getLocalStorage('patientInfo');
                console.log(this.patientInfo);
                this.areaId = this.patientInfo.areaId;
                this.getTemplateList();
            },
            methods: {
                getTemplateList() { // 获取模板列表
                    var params = {
                        pageNo: 1, //this.templatePage,
                        pageSize: 500, //this.templatePageSize,
                        param: {
                            areaCode: this.areaId,
                            name: this.templateName, // 模板名称
                            type: '2' // 病情模板值为2
                        }
                    }

                    Template.getPathography(params).then(res => {
                        if (res.code === 0) {
                            if (res.data) {
                                this.templateTableData = res.data.result;
                            } else {
                                this.templateTableData = [];
                            }
                        } else {
                            this.$message({
                                message: res.msg,
                                type: 'error'
                            })
                        }
                    })
                },
                getAdvices() {
                    this.adviceLoading = true;

                    function groupBy(array, f) { //医嘱分组
                        const groups = {};
                        array.forEach(function (o) {
                            const group = JSON.stringify(f(o));
                            groups[group] = groups[group] || [];
                            groups[group].push(o);
                        });
                        return Object.keys(groups).map(function (group) {
                            return groups[group];
                        });
                    }

                    let arr = []; //输入框显示内容
                    Advice.bottleSignPrint({
                        patientNos: [this.patientInfo.patientNo],
                        page: 1,
                        size: 300,
                        planExecDate: this.adviceDate, //this.formInline.selectDate,
                        wayType: '', //给药途径  输液单"1" 注射单"2" 雾化单"3"
                        timeLimit: '', //医嘱类型 长期"1" 临时"0"
                        printStatus: '', //"0"未打印  "1"已打印
                    }).then(res => {
                        this.total = res.data.totalCount
                        this.adviceTableData = []
                        let param = res.data.result;
                        const groupData = groupBy(param, function (item) {
                            return [item.placerGroupNumber, item.planExecTime];
                        });
                        if (groupData.length > 0) {
                            groupData.forEach((item, index) => {
                                item.forEach((item1, index1, arr) => {
                                    if (item.length > 1) {
                                        if (index1 === 0) {
                                            item[index1].leftFlag = '┌'
                                            item[index1].rightFlag = '┐'
                                            this.adviceTableData.push(item1)
                                        } else if (index1 === item.length - 1) {
                                            item[index1].leftFlag = '└'
                                            item[index1].rightFlag = '┘'
                                            this.adviceTableData.push(item1)
                                        } else {
                                            item[index1].leftFlag = '|'
                                            item[index1].rightFlag = '|'
                                            this.adviceTableData.push(item1)
                                        }
                                    } else {
                                        this.adviceTableData.push(item1)
                                    }
                                })
                            })
                        }
                        this.adviceLoading = false;
                    })
                },
                handleReordClick() { },
                handleSelectRow(row, column, cell, event) { // 病情模板选中内容
                    if (this.recordActiveName === 'first') {
                        this.specRecord += row.value.content + ' ';
                    } else if (this.recordActiveName === 'second') {
                        this.specRecord += row.diagnosisDescription + ' ';
                    } else if (this.recordActiveName === 'third') {
                        this.specRecord += row.projectName + ' ';
                    }
                },
                adviceDateChange(val) {
                    this.adviceDate = moment(val).format('YYYY-MM-DD');
                    this.getAdvices();
                },
                tableSelect(rows, row) { //选中
                    let _this = this;
                    let selected = rows.length && rows.indexOf(row) !== -1 //// true就是选中，0或者false是取消选中
                    if (selected) {
                        if (_this.adviceTableData.length > 0) {
                            _this.adviceTableData.forEach((item, index) => {
                                if (row.placerGroupNumber === item.placerGroupNumber && row.planExecTime === item.planExecTime) {
                                    _this.adviceSelectedArr.push(item)
                                    _this.$refs.multipleTable.toggleRowSelection(item, true)
                                    this.specRecord += (index !== 0 ? '+' : '') + item.adviceItemName + ' ' + item.dose + item.unit;
                                }
                            })
                        }
                    } else {
                        if (_this.adviceTableData.length > 0) {
                            _this.adviceTableData.forEach(item => {
                                if (row.placerGroupNumber === item.placerGroupNumber && row.planExecTime === item.planExecTime) {
                                    _this.adviceSelectedArr.forEach((group, i) => {
                                        if (group === item) {
                                            _this.adviceSelectedArr.splice(i, 1);
                                        }
                                    })
                                    _this.$refs.multipleTable.toggleRowSelection(item, false)
                                }
                            })
                        }
                    }
                },
                checkboxAll() { },
                insertContentToTable() { },
            }
        })
    </script>
    <script src="./static/js/emr.js"></script>
    <script src="./static/js/vendors~main.chunk.js"></script>
    <script src="./static/js/main.chunk.js"></script>
</body>

</html>